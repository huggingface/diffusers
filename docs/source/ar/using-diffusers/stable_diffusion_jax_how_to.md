# JAX/Flax

๐ค Diffusers ูุฏุนู Flax ููุญุตูู ุนูู ุงุณุชูุชุงุฌ ุณุฑูุน ููุบุงูุฉ ุนูู Google TPUsุ ูุซู ุชูู ุงููุชููุฑุฉ ูู Colab ุฃู Kaggle ุฃู Google Cloud Platform. ููุธูุฑ ูู ูุฐุง ุงูุฏููู ููููุฉ ุชุดุบูู ุงูุงุณุชุฏูุงู ุจุงุณุชุฎุฏุงู Stable Diffusion ุจุงุณุชุฎุฏุงู JAX/Flax.

ูุจู ุฃู ุชุจุฏุฃุ ุชุฃูุฏ ูู ุชุซุจูุช ุงูููุชุจุงุช ุงููุงุฒูุฉ:

```py
# ูู ุจุฅูุบุงุก ุงูุชุนููู ูุชุซุจูุช ุงูููุชุจุงุช ุงููุงุฒูุฉ ูู Colab
#! pip install -q jax==0.3.25 jaxlib==0.3.25 flax transformers ftfy
#! pip install -q diffusers
```

ูุฌุจ ุฃูุถูุง ุงูุชุฃูุฏ ูู ุงุณุชุฎุฏุงูู ูุฎูููุฉ TPU. ูู ุญูู ุฃู JAX ูุง ูุนูู ุญุตุฑููุง ุนูู ูุญุฏุงุช TPUุ ูุณุชุญุตู ุนูู ุฃูุถู ุฃุฏุงุก ุนูู ูุญุฏุฉ TPU ูุฃู ูู ุฎุงุฏู ูุญุชูู ุนูู 8 ูุณุฑุนุงุช TPU ุชุนูู ุจุงูุชูุงุฒู.

ุฅุฐุง ููุช ุชุดุบู ูุฐุง ุงูุฏููู ูู Colabุ ูุญุฏุฏ *Runtime* ูู ุงููุงุฆูุฉ ุฃุนูุงูุ ุซู ุญุฏุฏ ุฎูุงุฑ *Change runtime type*ุ ุซู ุญุฏุฏ *TPU* ุถูู ุฅุนุฏุงุฏ *Hardware accelerator*. ูู ุจุงุณุชูุฑุงุฏ JAX ูุงูุชุญูู ุจุณุฑุนุฉ ููุง ุฅุฐุง ููุช ุชุณุชุฎุฏู ูุญุฏุฉ TPU:

```python
import jax
import jax.tools.colab_tpu
jax.tools.colab_tpu.setup_tpu()

num_devices = jax.device_count()
device_type = jax.devices()[0].device_kind

print(f"Found {num_devices} JAX devices of type {device_type}.")
assert (
    "TPU" in device_type,
    "Available device is not a TPU, please select TPU from Runtime > Change runtime type > Hardware accelerator"
)
# Found 8 JAX devices of type Cloud TPU.
```


ุฑุงุฆุนุ ุงูุขู ููููู ุงุณุชูุฑุงุฏ ุจููุฉ ุงูุชุจุนูุงุช ุงูุชู ุณุชุญุชุงุฌูุง:

```python
import jax.numpy as jnp
from jax import pmap
from flax.jax_utils import replicate
from flax.training.common_utils import shard

from diffusers import FlaxStableDiffusionPipeline
```


## ุชุญููู ูููุฐุฌ

Flax ูู ุฅุทุงุฑ ุนูู ูุธูููุ ูุฐูู ูุฅู ุงูููุงุฐุฌ ุนุฏููุฉ ุงูุญุงูุฉ ูุงูุจุงุฑุงูุชุฑุงุช ูุฎุฒูุฉ ุฎุงุฑุฌูุง. ุชุญููู ุฎุท ุฃูุงุจูุจ Flax ุงููุนูู ูุณุจููุง ูุนูุฏ *ููุงู* ูู ุฎุท ุงูุฃูุงุจูุจ ููุฒู ุงููููุฐุฌ (ุฃู ุงููุนููุงุช). ูู ูุฐุง ุงูุฏูููุ ุณุชุณุชุฎุฏู `bfloat16`ุ ููู ููุน ูุตู ุนุงุฆู ุฃูุซุฑ ููุงุกุฉ ุชุฏุนูู ูุญุฏุงุช TPU (ููููู ุฃูุถูุง ุงุณุชุฎุฏุงู `float32` ููุฏูุฉ ุงููุงููุฉ ุฅุฐุง ููุช ุชุฑูุฏ).

```python
dtype = jnp.bfloat16
pipeline, params = FlaxStableDiffusionPipeline.from_pretrained(
    "CompVis/stable-diffusion-v1-4",
    revision="bf16",
    dtype=dtype,
)
```

## ุงูุงุณุชุฏูุงู

ุนุงุฏุฉู ูุง ุชุญุชูู ูุญุฏุงุช TPU ุนูู 8 ุฃุฌูุฒุฉ ุชุนูู ุจุงูุชูุงุฒูุ ูุฐุง ุฏุนูุง ูุณุชุฎุฏู ููุณ ุงููุญูุฒ ููู ุฌูุงุฒ. ููุฐุง ูุนูู ุฃูู ููููู ุฅุฌุฑุงุก ุงูุงุณุชุฏูุงู ุนูู 8 ุฃุฌูุฒุฉ ูู ููุณ ุงูููุชุ ูุน ููุงู ูู ุฌูุงุฒ ุจุชูููุฏ ุตูุฑุฉ ูุงุญุฏุฉ. ููุชูุฌุฉ ูุฐููุ ุณุชุญุตู ุนูู 8 ุตูุฑ ูู ููุณ ุงูููุช ุงูุฐู ูุณุชุบุฑูู ุงูุดุฑูุญุฉ ูุชูููุฏ ุตูุฑุฉ ูุงุญุฏุฉ!

<Tip>
ุชุนุฑู ุนูู ุงููุฒูุฏ ูู ุงูุชูุงุตูู ูู ูุณู [ููู ุชุนูู ุงูููุงุฒุงุฉุ](#how-does-parallelization-work).
</Tip>

ุจุนุฏ ุงุณุชูุณุงุฎ ุงููุญูุฒุ ุงุญุตู ุนูู ูุนุฑูุงุช ุงููุต ุงููุนูู ุจุงูุงุชุตุงู ุจูุธููุฉ `prepare_inputs` ุนูู ุฎุท ุงูุฃูุงุจูุจ. ุชู ุชุนููู ุทูู ุงููุต ุงููุนูู ุนูู 77 ุฑูุฒูุง ููุง ูู ูุทููุจ ูู ุฎูุงู ุชูููู ูููุฐุฌ CLIP ุงููุตู ุงูุฃุณุงุณู.

```python
prompt = "A cinematic film still of Morgan Freeman starring as Jimi Hendrix, portrait, 40mm lens, shallow depth of field, close up, split lighting, cinematic"
prompt = [prompt] * jax.device_count()
prompt_ids = pipeline.prepare_inputs(prompt)
prompt_ids.shape
# (8, 77)
```

ูุฌุจ ุชูุฑุงุฑ ูุนููุงุช ุงููููุฐุฌ ูุงููุฏุฎูุงุช ุนุจุฑ ุงูุฃุฌูุฒุฉ ุงููุชูุงุฒูุฉ 8. ูุชู ุชูุฑุงุฑ ูุงููุณ ุงููุนููุงุช ุจุงุณุชุฎุฏุงู [`flax.jax_utils.replicate`](https://flax.readthedocs.io/en/latest/api_reference/flax.jax_utils.html#flax.jax_utils.replicate) ุงูุฐู ูุชููู ูู ุงููุงููุณ ููุบูุฑ ุดูู ุงูุฃูุฒุงู ุจุญูุซ ูุชู ุชูุฑุงุฑูุง 8 ูุฑุงุช. ูุชู ุชูุฑุงุฑ ุงููุตูููุงุช ุจุงุณุชุฎุฏุงู `shard`.

```python
# parameters
p_params = replicate(params)

# arrays
prompt_ids = shard(prompt_ids)
prompt_ids.shape
# (8, 1, 77)
```

ูุนูู ูุฐุง ุงูุดูู ุฃู ูู ุฌูุงุฒ ูู ุงูุฃุฌูุฒุฉ ุงูุซูุงููุฉ ูุณุชูุจู ูุฅุฏุฎุงู ูุตูููุฉ `jnp` ุฐุงุช ุงูุดูู `(1ุ 77)`ุ ุญูุซ `1` ูู ุญุฌู ุงูุฏูุนุฉ ููู ุฌูุงุฒ. ูู ูุญุฏุงุช TPU ุฐุงุช ุงูุฐุงูุฑุฉ ุงููุงููุฉุ ูููู ุฃู ูููู ุญุฌู ุงูุฏูุนุฉ ุฃูุจุฑ ูู `1` ุฅุฐุง ููุช ุชุฑูุฏ ุฅูุดุงุก ุตูุฑ ูุชุนุฏุฏุฉ (ููุดุฑูุญุฉ) ูู ููุณ ุงูููุช.

ุจุนุฏ ุฐููุ ูู ุจุฅูุดุงุก ูููุฏ ุฑูู ุนุดูุงุฆู ูุชูุฑูุฑู ุฅูู ูุธููุฉ ุงูุชูููุฏ. ูุฐุง ูู ุงูุฅุฌุฑุงุก ุงูููุงุณู ูู Flaxุ ูุงูุฐู ูููู ุฌุงุฏูุง ููุชุนุฌุฑููุง ุจุดุฃู ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ. ูู ุงููุชููุน ุฃู ุชุชููู ุฌููุน ุงููุธุงุฆู ุงูุชู ุชุชุนุงูู ูุน ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ ูููุฏูุง ูุถูุงู ุฅููุงููุฉ ุฅุนุงุฏุฉ ุงูุฅูุชุงุฌุ ุญุชู ุนูุฏ ุงูุชุฏุฑูุจ ุนุจุฑ ุฃุฌูุฒุฉ ููุฒุนุฉ ูุชุนุฏุฏุฉ.

ุชุณุชุฎุฏู ูุธููุฉ ุงููุณุงุนุฏุฉ ุฃุฏูุงู ุจุฐุฑุฉ ูุชููุฆุฉ ูููุฏ ุฑูู ุนุดูุงุฆู. ุทุงููุง ุฃูู ุชุณุชุฎุฏู ููุณ ุงูุจุฐุฑุฉุ ูุณุชุญุตู ุนูู ููุณ ุงููุชุงุฆุฌ ุจุงูุถุจุท. ูุง ุชุชุฑุฏุฏ ูู ุงุณุชุฎุฏุงู ุจุฐูุฑ ูุฎุชููุฉ ุนูุฏ ุงุณุชูุดุงู ุงููุชุงุฆุฌ ูุงุญููุง ูู ุงูุฏููู.

```python
def create_key(seed=0):
    return jax.random.PRNGKey(seed)
```

ูุชู ุชูุณูู ูุธููุฉ ุงููุณุงุนุฏุฉุ ุฃู `rng`ุ 8 ูุฑุงุช ุจุญูุซ ูุชููู ูู ุฌูุงุฒ ูููุฏูุง ูุฎุชูููุง ูููุดุฆ ุตูุฑุฉ ูุฎุชููุฉ.

```python
rng = create_key(0)
rng = jax.random.split(rng, jax.device_count())
```

ูุงุณุชุบูุงู ุณุฑุนุฉ JAX ุงููุญุณูุฉ ุนูู ูุญุฏุฉ TPUุ ูู ุจุชูุฑูุฑ `jit=True` ุฅูู ุฎุท ุงูุฃูุงุจูุจ ูุชุฌููุน ุฑูุฒ JAX ุฅูู ุชูุซูู ูุนุงู ูุถูุงู ุชุดุบูู ุงููููุฐุฌ ุจุงูุชูุงุฒู ุนุจุฑ ุงูุฃุฌูุฒุฉ ุงูุซูุงููุฉ.

<Tip warning={true}>
ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ูุฏุฎูุงุชู ููุง ููุณ ุงูุดูู ูู ุงูููุงููุงุช ุงููุงุญูุฉุ ูุฅูุง ูุณูุชุนูู ุนูู JAX ุฅุนุงุฏุฉ ุชุฌููุน ุงูุฑูุฒ ููู ุฃุจุทุฃ.
</Tip>

ุชุณุชุบุฑู ุฃูู ุนูููุฉ ุงุณุชุฏูุงู ููุชูุง ุฃุทูู ูุฃููุง ุชุญุชุงุฌ ุฅูู ุชุฌููุน ุงูุฑูุฒุ ูููู ุงูููุงููุงุช ุงููุงุญูุฉ (ุญุชู ูุน ูุฏุฎูุงุช ูุฎุชููุฉ) ุชููู ุฃุณุฑุน ุจูุซูุฑ. ุนูู ุณุจูู ุงููุซุงูุ ุงุณุชุบุฑู ุงูุฃูุฑ ุฃูุซุฑ ูู ุฏูููุฉ ูุชุฌููุน ุนูู ูุญุฏุฉ TPU v2-8ุ ูููู ูุณุชุบุฑู ุญูุงูู **7 ุซูุงูู** ูู ุนูููุฉ ุงุณุชุฏูุงู ูุณุชูุจููุฉ!

```py
%%time
images = pipeline(prompt_ids, p_params, rng, jit=True)[0]

# CPU times: user 56.2 s, sys: 42.5 s, total: 1min 38s
# Wall time: 1min 29s
```

ูููู ูููุตูููุฉ ุงูุชู ุชูุช ุฅุนุงุฏุชูุง ุงูุดูู `(8ุ 1ุ 512ุ 512ุ 3)` ูุงูุฐู ูุฌุจ ุฅุนุงุฏุฉ ุชุดูููู ูุฅุฒุงูุฉ ุงูุจุนุฏ ุงูุซุงูู ูุงูุญุตูู ุนูู 8 ุตูุฑ ุจุญุฌู `512 ร 512 ร 3`. ุจุนุฏ ุฐููุ ููููู ุงุณุชุฎุฏุงู ูุธููุฉ [`~utils.numpy_to_pil`] ูุชุญููู ุงููุตูููุงุช ุฅูู ุตูุฑ.

```python
from diffusers.utils import make_image_grid

images = images.reshape((images.shape[0] * images.shape[1],) + images.shape[-3:])
images = pipeline.numpy_to_pil(images)
make_image_grid(images, rows=2, cols=4)
```

![img](https://huggingface.co/datasets/YiYiXu/test-doc-assets/resolve/main/stable_diffusion_jax_how_to_cell_38_output_0.jpeg)

## ุงุณุชุฎุฏุงู ูุญูุฒุงุช ูุฎุชููุฉ

ุฃูุช ูุณุช ูุถุทุฑูุง ูุงุณุชุฎุฏุงู ููุณ ุงููุญูุฒ ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ. ุนูู ุณุจูู ุงููุซุงูุ ูุฅูุดุงุก 8 ูุญูุฒุงุช ูุฎุชููุฉ:

```python
prompts = [
    "Labrador in the style of Hokusai",
    "Painting of a squirrel skating in New York",
    "HAL-9000 in the style of Van Gogh",
    "Times Square under water, with fish and a dolphin swimming around",
    "Ancient Roman fresco showing a man working on his laptop",
    "Close-up photograph of young black woman against urban background, high quality, bokeh",
    "Armchair in the shape of an avocado",
    "Clown astronaut in space, with Earth in the background",
]

prompt_ids = pipeline.prepare_inputs(prompts)
prompt_ids = shard(prompt_ids)

images = pipeline(prompt_ids, p_params, rng, jit=True).images
images = images.reshape((images.shape[0] * images.shape[1],) + images.shape[-3:])
images = pipeline.numpy_to_pil(images)

make_image_grid(images, 2, 4)
```

![img](https://huggingface.co/datasets/YiYiXu/test-doc-assets/resolve/main/stable_diffusion_jax_how_to_cell_43_output_0.jpeg)

## ููู ุชุนูู ุงูููุงุฒุงุฉุ How does parallelization work?

ูููู ุฎุท ุฃูุงุจูุจ Flax ูู ๐ค Diffusers ุจุชุฌููุน ุงููููุฐุฌ ูุชุดุบููู ุชููุงุฆููุง ุจุงูุชูุงุฒู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ ุงููุชุงุญุฉ. ุฏุนูุง ูููู ูุธุฑุฉ ูุงุญุตุฉ ุนูู ููููุฉ ุนูู ูุฐู ุงูุนูููุฉ.

ูููู ุฅุฌุฑุงุก ููุงุฒุงุฉ JAX ุจุนุฏุฉ ุทุฑู. ุฃุณูููุง ูุฏูุฑ ุญูู ุงุณุชุฎุฏุงู ูุธููุฉ [`jax.pmap`](https://jax.readthedocs.io/en/latest/_autosummary/jax.pmap.html) ูุชุญููู ููุงุฒุงุฉ ุงูุจุฑูุงูุฌ ุงููุฑุฏู ูุงูุจูุงูุงุช ุงููุชุนุฏุฏุฉ (SPMD). ููุฐุง ูุนูู ุชุดุบูู ุนุฏุฉ ูุณุฎ ูู ููุณ ุงูุฑูุฒุ ูู ูููุง ุนูู ูุฏุฎูุงุช ุจูุงูุงุช ูุฎุชููุฉ. ูู ุงููููู ุงุชุจุงุน ููุฌ ุฃูุซุฑ ุชูุฏููุงุ ูููููู ุงูุงูุชูุงู ุฅูู ูุซุงุฆู JAX [documentation](https://jax.readthedocs.io/en/latest/index.html) ูุงุณุชูุดุงู ูุฐุง ุงูููุถูุน ุจูุฒูุฏ ูู ุงูุชูุตูู ุฅุฐุง ููุช ููุชููุง!

`jax.pmap` ููุนู ุดูุฆูู:

1. ูููู ุจุชุฌููุน (ุฃู "jit") ุงูุฑูุฒ ุงูุฐู ูุดุจู `jax.jit()`. ูุง ูุญุฏุซ ูุฐุง ุนูุฏ ุงุณุชุฏุนุงุก `pmap`ุ ูููู ููุท ูู ุงููุฑุฉ ุงูุฃููู ุงูุชู ูุชู ูููุง ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ `pmap`ped.
2. ูุถูู ุชุดุบูู ุงูุฑูุฒ ุงููุฌูุน ุจุงูุชูุงุฒู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ ุงููุชุงุญุฉ.

ูุฅุซุจุงุช ุฐููุ ูู ุจุงูุงุชุตุงู ุจู `pmap` ุนูู ุทุฑููุฉ `_generate` ูู ุฎุท ุงูุฃูุงุจูุจ (ูุฐู ุทุฑููุฉ ุฎุงุตุฉ ุชููู ุจุชูููุฏ ุงูุตูุฑ ููุฏ ูุชู ุฅุนุงุฏุฉ ุชุณููุชูุง ุฃู ุฅุฒุงูุชูุง ูู ุงูุฅุตุฏุงุฑุงุช ุงููุณุชูุจููุฉ ูู ๐ค Diffusers):

```python
p_generate = pmap(pipeline._generate)
```

ุจุนุฏ ุงุณุชุฏุนุงุก `pmap`ุ ุณุชุนูู ุงููุธููุฉ ุงููุญุถุฑุฉ `p_generate` ุนูู:

1. ูู ุจุนูู ูุณุฎุฉ ูู ุงููุธููุฉ ุงูุฃุณุงุณูุฉุ `pipeline._generate`ุ ุนูู ูู ุฌูุงุฒ.
2. ุฅุฑุณุงู ูู ุฌูุงุฒ ุฌุฒุก ูุฎุชูู ูู ุญุฌุฌ ุงูุฅุฏุฎุงู (ูุฐุง ูู ุงูุณุจุจ ูู ุฃูู ูู ุงูุถุฑูุฑู ุงุณุชุฏุนุงุก ูุธููุฉ *shard*). ูู ูุฐู ุงูุญุงูุฉุ ูููู ูู `prompt_ids` ุงูุดูู `(8ุ 1ุ 77ุ 768)` ูุฐุง ูุชู ุชูุณูู ุงููุตูููุฉ ุฅูู 8 ููุณุชูุจู ูู ูุณุฎุฉ ูู `_generate` ุฅุฏุฎุงููุง ุจุดูู `(1ุ 77ุ 768)`.

ุฃูู ุดูุก ูุฌุจ ุงูุงูุชุจุงู ุฅููู ููุง ูู ุญุฌู ุงูุฏูุนุฉ (1 ูู ูุฐุง ุงููุซุงู) ูุฃุจุนุงุฏ ุงูุฅุฏุฎุงู ุงูุชู ููุง ูุนูู ูุฑูุฒู. ูุง ููุฒูู ุชุบููุฑ ุฃู ุดูุก ุขุฎุฑ ูุฌุนู ุงูุฑูุฒ ูุนูู ุจุงูุชูุงุฒู.

ุชุณุชุบุฑู ุฃูู ููุงููุฉ ูุฎุท ุงูุฃูุงุจูุจ ููุชูุง ุฃุทููุ ูููู ุงูููุงููุงุช ุงููุงุญูุฉ ุชููู ุฃุณุฑุน ุจูุซูุฑ. ูุชู ุงุณุชุฎุฏุงู ูุธููุฉ `block_until_ready` ูููุงุณ ููุช ุงูุงุณุชุฏูุงู ุจุดูู ุตุญูุญ ูุฃู JAX ูุณุชุฎุฏู ุงูุฅุฑุณุงู ุบูุฑ ุงููุชุฒุงูู ููุนูุฏ ุงูุชุญูู ุฅูู ุญููุฉ Python ุจูุฌุฑุฏ ุฃู ูุชููู ูู ุฐูู. ูุง ุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู ุฐูู ูู ุฑูุฒูุ ูุญุฏุซ ุงูุญุธุฑ ุชููุงุฆููุง ุนูุฏูุง ุชุฑูุฏ ุงุณุชุฎุฏุงู ูุชูุฌุฉ ุญุณุงุจ ูู ูุชู ุชุญูููู ุจุนุฏ.

```py
%%time
images = p_generate(prompt_ids, p_params, rng)
images = images.block_until_ready()

# CPU times: user 1min 15s, sys: 18.2 s, total: 1min 34s
# Wall time: 1min 15s
```

ุชุญูู ูู ุฃุจุนุงุฏ ุงูุตูุฑุฉ ููุนุฑูุฉ ูุง ุฅุฐุง ูุงูุช ุตุญูุญุฉ:

```python
images.shape
# (8ุ 1ุ 512ุ 512ุ 3)
```

## ุงูููุงุฑุฏ

ููุนุฑูุฉ ุงููุฒูุฏ ุญูู ููููุฉ ุนูู JAX ูุน Stable Diffusionุ ูุฏ ุชููู ููุชููุง ุจูุฑุงุกุฉ:

* [ุชุณุฑูุน ุงุณุชุฏูุงู Stable Diffusion XL ุจุงุณุชุฎุฏุงู JAX ุนูู Cloud TPU v5e](https://hf.co/blog/sdxl_jax)